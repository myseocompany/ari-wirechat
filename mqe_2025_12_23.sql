-- -------------------------------------------------------------
-- TablePlus 6.7.8(650)
--
-- https://tableplus.com/
--
-- Database: ariwirechat
-- Generation Time: 2025-12-23 12:51:17.3080
-- -------------------------------------------------------------


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;


DROP VIEW IF EXISTS `RFM2025`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM2025_BASE`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM_2025`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM_2025_TEST`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM_2025_WINNERS`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM_2025_WINNERS_`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `RFM_2025_test`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP TABLE IF EXISTS `account_files`;
CREATE TABLE `account_files` (
  `id` int unsigned NOT NULL,
  `account_id` int NOT NULL,
  `url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `accounts`;
CREATE TABLE `accounts` (
  `id` int unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `account_status_id` int DEFAULT NULL,
  `document` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `phone` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `address` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `email` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `employee_number` int DEFAULT NULL,
  `project_budget` bigint DEFAULT NULL,
  `fee_budget` bigint DEFAULT NULL,
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `action_types`;
CREATE TABLE `action_types` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `description` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `outbound` int DEFAULT '0',
  `followup` int DEFAULT NULL,
  `weigth` int DEFAULT NULL,
  `icon` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `color` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=108 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `actions`;
CREATE TABLE `actions` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `note` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `url` varchar(1024) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `retell_call_id` varchar(191) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `due_date` datetime DEFAULT NULL,
  `delivery_date` datetime DEFAULT NULL,
  `notified_at` datetime DEFAULT NULL,
  `object_id` int DEFAULT NULL,
  `customer_id` bigint DEFAULT NULL,
  `customer_owner_id` int DEFAULT NULL COMMENT 'a quien estaba asociado el usuario',
  `customer_createad_at` timestamp NULL DEFAULT NULL,
  `customer_updated_at` timestamp NULL DEFAULT NULL,
  `type_id` int NOT NULL,
  `creator_user_id` int DEFAULT NULL,
  `owner_user_id` int DEFAULT NULL COMMENT 'a quien se atribuye la venta',
  `sale_date` date DEFAULT NULL,
  `sale_amount` double DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `deleted_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uniq_actions_retell_call_id` (`retell_call_id`),
  KEY `customer_id` (`customer_id`),
  KEY `type_id` (`type_id`),
  KEY `idx_actions_event_tag` (`customer_id`,`created_at`),
  KEY `idx_actions_note_tag` (`note`(191)),
  KEY `idx_actions_type` (`type_id`,`created_at`),
  KEY `idx_actions_customer_time` (`customer_id`,`created_at`),
  KEY `idx_actions_type_time` (`type_id`,`created_at`),
  KEY `actions_notified_at_index` (`notified_at`),
  KEY `idx_actions_notify` (`notified_at`,`delivery_date`,`due_date`,`id`),
  KEY `idx_actions_customer_delivery_due` (`customer_id`,`delivery_date`,`due_date`),
  KEY `idx_actions_customer_created` (`customer_id`,`created_at`)
) ENGINE=InnoDB AUTO_INCREMENT=665404 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `audience_customer`;
CREATE TABLE `audience_customer` (
  `id` int NOT NULL,
  `customer_id` bigint NOT NULL,
  `audience_id` int NOT NULL DEFAULT '2',
  `sended_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `customer_id` (`customer_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `audiences`;
CREATE TABLE `audiences` (
  `id` int NOT NULL,
  `name` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `msg1` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `msg2` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `type_id` int DEFAULT '0',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `cache`;
CREATE TABLE `cache` (
  `key` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `value` mediumtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `expiration` int NOT NULL,
  PRIMARY KEY (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `cache_locks`;
CREATE TABLE `cache_locks` (
  `key` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `owner` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `expiration` int NOT NULL,
  PRIMARY KEY (`key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `campaign_customer_meta_data`;
CREATE TABLE `campaign_customer_meta_data` (
  `id` int NOT NULL,
  `campaign_id` int DEFAULT NULL,
  `customer_meta_data_id` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `campaign_messages`;
CREATE TABLE `campaign_messages` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `campaign_id` int DEFAULT NULL,
  `component` varchar(50) COLLATE utf8mb3_unicode_ci NOT NULL DEFAULT 'body',
  `sequence` int unsigned NOT NULL DEFAULT '1',
  `source` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `fallback` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `text` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `payload` json DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `campaigns`;
CREATE TABLE `campaigns` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `description` text COLLATE utf8mb3_unicode_ci,
  `audience_id` int DEFAULT NULL,
  `filters` json DEFAULT NULL,
  `max_recipients` int unsigned DEFAULT NULL,
  `whatsapp_account_id` bigint unsigned DEFAULT NULL,
  `whatsapp_template_id` bigint unsigned DEFAULT NULL,
  `template_name` varchar(190) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `template_language` varchar(10) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `header_type` varchar(20) COLLATE utf8mb3_unicode_ci NOT NULL DEFAULT 'none',
  `header_media_url` varchar(500) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `wait_seconds` int unsigned NOT NULL DEFAULT '30',
  `action_note` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `settings` json DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `campaigns_whatsapp_account_id_foreign` (`whatsapp_account_id`),
  KEY `campaigns_whatsapp_template_id_foreign` (`whatsapp_template_id`),
  CONSTRAINT `campaigns_whatsapp_account_id_foreign` FOREIGN KEY (`whatsapp_account_id`) REFERENCES `whatsapp_accounts` (`id`) ON DELETE SET NULL,
  CONSTRAINT `campaigns_whatsapp_template_id_foreign` FOREIGN KEY (`whatsapp_template_id`) REFERENCES `whatsapp_templates` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB AUTO_INCREMENT=46 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `categories`;
CREATE TABLE `categories` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `parent_id` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `delivery_date` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `configs`;
CREATE TABLE `configs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `key` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `value` text COLLATE utf8mb4_unicode_ci,
  `type` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'string',
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `configs_key_unique` (`key`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `countries`;
CREATE TABLE `countries` (
  `id` int unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `name_en` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `nom` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `iso2` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `iso3` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone_code` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `iso2` (`iso2`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_cleaned_phones`;
CREATE TABLE `customer_cleaned_phones` (
  `id` int NOT NULL,
  `original_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `formatted_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `cleaned_phone` varchar(20) NOT NULL,
  `source_priority` int DEFAULT NULL,
  PRIMARY KEY (`id`,`cleaned_phone`),
  KEY `idx_cleaned_phone` (`cleaned_phone`),
  KEY `idx_priority` (`source_priority`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

DROP TABLE IF EXISTS `customer_files`;
CREATE TABLE `customer_files` (
  `id` int NOT NULL AUTO_INCREMENT,
  `customer_id` int DEFAULT NULL,
  `action_id` int DEFAULT NULL,
  `url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  `creator_user_id` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16879 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `customer_histories`;
CREATE TABLE `customer_histories` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `customer_id` int NOT NULL,
  `status_id` int DEFAULT NULL,
  `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `document` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `position` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `business` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone2` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `email` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `technical_visit` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `notes` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `address` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `city` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `country` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `department` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `bought_products` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `source_id` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  `vas` int DEFAULT NULL,
  `updated_user_id` int DEFAULT NULL,
  `count_empanadas` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_customer_histories_customers` (`customer_id`)
) ENGINE=MyISAM AUTO_INCREMENT=202714 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_last9_all`;
CREATE TABLE `customer_last9_all` (
  `phone_last9` char(9) COLLATE utf8mb3_unicode_ci NOT NULL,
  PRIMARY KEY (`phone_last9`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_meta_datas`;
CREATE TABLE `customer_meta_datas` (
  `id` int NOT NULL,
  `parent_id` int DEFAULT NULL,
  `value` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `type_id` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_metas`;
CREATE TABLE `customer_metas` (
  `id` int NOT NULL AUTO_INCREMENT,
  `meta_data_type_id` int DEFAULT NULL,
  `customer_id` int DEFAULT NULL,
  `meta_data_id` int DEFAULT NULL,
  `value` varchar(1000) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `audience_id` int DEFAULT NULL,
  `created_at` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `updated_at` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=16327 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_sources`;
CREATE TABLE `customer_sources` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `redirect_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `active` int DEFAULT '1',
  `rd_source` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `rd_source_en` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=79 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_stages`;
CREATE TABLE `customer_stages` (
  `id` int NOT NULL,
  `name` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `status_id` int DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_status_phases`;
CREATE TABLE `customer_status_phases` (
  `id` int NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `parent_id` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `url` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_statuses`;
CREATE TABLE `customer_statuses` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(250) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `color` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `stage_id` int DEFAULT NULL,
  `status_id` int DEFAULT NULL,
  `followup` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `parent_id` int DEFAULT NULL,
  `next_id` int DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=71 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_tag`;
CREATE TABLE `customer_tag` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `customer_id` int NOT NULL,
  `tag_id` int unsigned NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `customer_tag_customer_id_tag_id_unique` (`customer_id`,`tag_id`),
  KEY `customer_tag_customer_id_index` (`customer_id`),
  KEY `customer_tag_tag_id_index` (`tag_id`),
  KEY `idx_customer_tag_tag_customer` (`tag_id`,`customer_id`),
  KEY `idx_customer_tag_customer_tag` (`customer_id`,`tag_id`)
) ENGINE=InnoDB AUTO_INCREMENT=16737 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `customer_types`;
CREATE TABLE `customer_types` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) COLLATE utf8mb3_unicode_ci NOT NULL,
  `description` text COLLATE utf8mb3_unicode_ci,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customer_unsubscribes`;
CREATE TABLE `customer_unsubscribes` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `phone` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL DEFAULT '',
  `note` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customers`;
CREATE TABLE `customers` (
  `id` int NOT NULL AUTO_INCREMENT,
  `source_id` int DEFAULT NULL,
  `maker` int DEFAULT NULL,
  `count_empanadas` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `scoring` int DEFAULT NULL COMMENT '0 mal calificado, 1 para oportunidad',
  `session_id` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `custom_fields` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `rd_station_response` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `status_id` int DEFAULT NULL,
  `rfm_r` varchar(2) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `rfm_f` varchar(2) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `rfm_m` varchar(2) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `inquiry_product_id` int DEFAULT NULL,
  `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `document` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `position` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `lead_id` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `google_lead_id` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `phone2` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `contact_phone2` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `phone_wp` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `area_code` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `postal_code` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `business_document` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_phone` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_area_code` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_address` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_email` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `business_city` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `email` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `address` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `city` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `country` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `department` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_position` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `bought_products` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `purchase_date` date DEFAULT NULL,
  `notes` longtext CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `technical_visit` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `gender` varchar(2) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `scoring_interest` int DEFAULT NULL,
  `scoring_profile` varchar(1) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `rd_public_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `rd_lead_id` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `src` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `cid` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `vas` int DEFAULT NULL,
  `rd_source` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `updated_user_id` int DEFAULT NULL,
  `creator_user_id` int DEFAULT NULL,
  `country2` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `company_type` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `number_venues` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `empanadas_size` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `utm_source` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Use utm_source to identify a search engine, newsletter name, or other source.',
  `utm_medium` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Use utm_medium to identify a medium such as email or cost-per-click.',
  `utm_campaign` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for keyword analysis. Use utm_campaign to identify a specific product promotion or strategic campaign.',
  `utm_term` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for paid search. Use utm_term to note the keywords for this ad.',
  `utm_content` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for A/B testing and content-targeted ads. Use utm_content to differentiate ads or links that point to the same URL.',
  `image_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `linkedin_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `company_description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `ad_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `adset_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `campaign_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `country_temp` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `facebook_id` bigint unsigned DEFAULT NULL,
  `total_sold` int DEFAULT NULL,
  `contact_phone2_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`contact_phone2`,9)) STORED,
  `phone_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone`,9)) STORED,
  `phone2_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone2`,9)) STORED,
  `phone_wp_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone_wp`,9)) STORED,
  PRIMARY KEY (`id`),
  KEY `email` (`email`),
  KEY `business_email` (`business_email`),
  KEY `contact_email` (`contact_email`),
  KEY `phone` (`phone`),
  KEY `phone2` (`phone2`),
  KEY `phone_wp` (`phone_wp`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status_id` (`status_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_country` (`country`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_updated_at` (`updated_at`),
  KEY `idx_source_id` (`source_id`),
  KEY `idx_inquiry_product_id` (`inquiry_product_id`),
  KEY `idx_maker` (`maker`),
  KEY `idx_customers_notes_tag` (`notes`(191)),
  KEY `idx_customers_source` (`source_id`,`maker`),
  KEY `idx_contact_phone2_last9` (`contact_phone2_last9`),
  KEY `idx_contact_phone2` (`contact_phone2`),
  KEY `idx_phone_last9` (`phone_last9`),
  KEY `idx_phone2_last9` (`phone2_last9`),
  KEY `idx_phone_wp_last9` (`phone_wp_last9`),
  KEY `idx_customers_product_source_created` (`product_id`,`source_id`,`created_at`),
  KEY `idx_customers_interest_profile` (`scoring_interest`,`scoring_profile`),
  KEY `idx_customers_phone_last9` (`phone_last9`),
  KEY `idx_customers_phone2_last9` (`phone2_last9`),
  KEY `idx_customers_contact_phone2_last9` (`contact_phone2_last9`),
  KEY `idx_customers_status_user_created` (`status_id`,`user_id`,`created_at`),
  KEY `idx_customers_country_created` (`country`,`created_at`),
  KEY `customers_rd_lead_id_index` (`rd_lead_id`)
) ENGINE=InnoDB AUTO_INCREMENT=673640 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `customers_clone`;
CREATE TABLE `customers_clone` (
  `id` int NOT NULL AUTO_INCREMENT,
  `source_id` int DEFAULT NULL,
  `maker` int DEFAULT NULL,
  `count_empanadas` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `scoring` int DEFAULT NULL COMMENT '0 mal calificado, 1 para oportunidad',
  `session_id` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `custom_fields` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `rd_station_response` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `status_id` int DEFAULT NULL,
  `inquiry_product_id` int DEFAULT NULL,
  `name` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `document` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `position` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `lead_id` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `phone` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `phone2` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `contact_phone2` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `phone_wp` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `area_code` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `postal_code` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `business_document` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_phone` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_area_code` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_address` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `business_email` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `business_city` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `email` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `address` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `city` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `country` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `department` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `contact_position` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `bought_products` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `purchase_date` date DEFAULT NULL,
  `notes` longtext CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `technical_visit` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `gender` varchar(2) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `scoring_interest` int DEFAULT NULL,
  `scoring_profile` varchar(1) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `rd_public_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `src` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `cid` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `vas` int DEFAULT NULL,
  `rd_source` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `updated_user_id` int DEFAULT NULL,
  `creator_user_id` int DEFAULT NULL,
  `country2` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `company_type` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `number_venues` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `empanadas_size` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `utm_source` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Use utm_source to identify a search engine, newsletter name, or other source.',
  `utm_medium` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Use utm_medium to identify a medium such as email or cost-per-click.',
  `utm_campaign` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for keyword analysis. Use utm_campaign to identify a specific product promotion or strategic campaign.',
  `utm_term` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for paid search. Use utm_term to note the keywords for this ad.',
  `utm_content` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL COMMENT 'Used for A/B testing and content-targeted ads. Use utm_content to differentiate ads or links that point to the same URL.',
  `image_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `linkedin_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `company_description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `ad_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `adset_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `campaign_name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `country_temp` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `facebook_id` bigint unsigned DEFAULT NULL,
  `total_sold` int DEFAULT NULL,
  `contact_phone2_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`contact_phone2`,9)) STORED,
  `phone_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone`,9)) STORED,
  `phone2_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone2`,9)) STORED,
  `phone_wp_last9` char(9) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci GENERATED ALWAYS AS (right(`phone_wp`,9)) STORED,
  PRIMARY KEY (`id`),
  KEY `email` (`email`),
  KEY `business_email` (`business_email`),
  KEY `contact_email` (`contact_email`),
  KEY `phone` (`phone`),
  KEY `phone2` (`phone2`),
  KEY `phone_wp` (`phone_wp`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status_id` (`status_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_country` (`country`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_updated_at` (`updated_at`),
  KEY `idx_source_id` (`source_id`),
  KEY `idx_inquiry_product_id` (`inquiry_product_id`),
  KEY `idx_maker` (`maker`),
  KEY `idx_customers_notes_tag` (`notes`(191)),
  KEY `idx_customers_source` (`source_id`,`maker`),
  KEY `idx_contact_phone2_last9` (`contact_phone2_last9`),
  KEY `idx_contact_phone2` (`contact_phone2`),
  KEY `idx_phone_last9` (`phone_last9`),
  KEY `idx_phone2_last9` (`phone2_last9`),
  KEY `idx_phone_wp_last9` (`phone_wp_last9`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `duplicated_email`;
CREATE TABLE `duplicated_email` (
  `email` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `email_queue_statuses`;
CREATE TABLE `email_queue_statuses` (
  `id` int NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `email_queues`;
CREATE TABLE `email_queues` (
  `id` int NOT NULL,
  `user_id` int NOT NULL,
  `email_id` int NOT NULL,
  `subject` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `view` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `available_at` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `updated_at` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `sended_at` timestamp NULL DEFAULT NULL,
  `email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `status_id` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `email_types`;
CREATE TABLE `email_types` (
  `id` int NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `logo_url` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` date DEFAULT NULL,
  `updated_at` date DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `emails`;
CREATE TABLE `emails` (
  `id` int NOT NULL,
  `name` int DEFAULT NULL,
  `scheduled_at` timestamp NULL DEFAULT NULL,
  `content` longtext CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `subject` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `view` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `audience_id` int NOT NULL DEFAULT '2',
  `query` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `type_id` int DEFAULT NULL,
  `active` int DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `sended_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `employee_files`;
CREATE TABLE `employee_files` (
  `id` int unsigned NOT NULL,
  `employee_id` int NOT NULL,
  `url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `employee_statuses`;
CREATE TABLE `employee_statuses` (
  `id` int unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `failed_jobs`;
CREATE TABLE `failed_jobs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `uuid` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `connection` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `queue` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `payload` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `exception` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `failed_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `failed_jobs_uuid_unique` (`uuid`)
) ENGINE=InnoDB AUTO_INCREMENT=25 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `final_missing_records`;
CREATE TABLE `final_missing_records` (
  `Nombre` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `email` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `Telfono` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `Telfono celular` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `Fecha de la primera conversin` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone_wp` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
  `Fuente de la primera conversin` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `import_clean`;
CREATE TABLE `import_clean` (
  `email` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `name` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `phone` text COLLATE utf8mb3_unicode_ci,
  `phone2` text COLLATE utf8mb3_unicode_ci,
  `business` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `Pas` text COLLATE utf8mb3_unicode_ci,
  `Estado` text COLLATE utf8mb3_unicode_ci,
  `Ciudad` text COLLATE utf8mb3_unicode_ci,
  `Pais2` text COLLATE utf8mb3_unicode_ci,
  `Contact_phone2` text COLLATE utf8mb3_unicode_ci,
  `Production` text COLLATE utf8mb3_unicode_ci,
  `phone_wp` text COLLATE utf8mb3_unicode_ci,
  `phone3_last9` char(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_contact_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_last9` varchar(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `import_phone_new`;
CREATE TABLE `import_phone_new` (
  `email` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `name` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `phone` text COLLATE utf8mb3_unicode_ci,
  `phone2` text COLLATE utf8mb3_unicode_ci,
  `business` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `Pas` text COLLATE utf8mb3_unicode_ci,
  `Estado` text COLLATE utf8mb3_unicode_ci,
  `Ciudad` text COLLATE utf8mb3_unicode_ci,
  `Pais2` text COLLATE utf8mb3_unicode_ci,
  `Contact_phone2` text COLLATE utf8mb3_unicode_ci,
  `Production` text COLLATE utf8mb3_unicode_ci,
  `phone_wp` text COLLATE utf8mb3_unicode_ci,
  `phone3_last9` char(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_contact_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_last9` varchar(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `import_updates`;
CREATE TABLE `import_updates` (
  `email` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `name` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `phone` text COLLATE utf8mb3_unicode_ci,
  `phone2` text COLLATE utf8mb3_unicode_ci,
  `business` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `Pas` text COLLATE utf8mb3_unicode_ci,
  `Estado` text COLLATE utf8mb3_unicode_ci,
  `Ciudad` text COLLATE utf8mb3_unicode_ci,
  `Pais2` text COLLATE utf8mb3_unicode_ci,
  `Contact_phone2` text COLLATE utf8mb3_unicode_ci,
  `Production` text COLLATE utf8mb3_unicode_ci,
  `phone_wp` text COLLATE utf8mb3_unicode_ci,
  `phone3_last9` char(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `clean_contact_phone2` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_phone` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `main_last9` varchar(9) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `customer_id` int DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `job_batches`;
CREATE TABLE `job_batches` (
  `id` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `total_jobs` int NOT NULL,
  `pending_jobs` int NOT NULL,
  `failed_jobs` int NOT NULL,
  `failed_job_ids` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `options` mediumtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `cancelled_at` int DEFAULT NULL,
  `created_at` int NOT NULL,
  `finished_at` int DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `jobs`;
CREATE TABLE `jobs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `queue` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `payload` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `attempts` tinyint unsigned NOT NULL,
  `reserved_at` int unsigned DEFAULT NULL,
  `available_at` int unsigned NOT NULL,
  `created_at` int unsigned NOT NULL,
  PRIMARY KEY (`id`),
  KEY `jobs_queue_index` (`queue`)
) ENGINE=InnoDB AUTO_INCREMENT=11510 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `lead_assignment_logs`;
CREATE TABLE `lead_assignment_logs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned DEFAULT NULL,
  `customer_id` bigint unsigned DEFAULT NULL,
  `context` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `meta` json DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `lead_assignment_logs_user_id_index` (`user_id`),
  KEY `lead_assignment_logs_customer_id_index` (`customer_id`),
  KEY `lead_assignment_logs_context_index` (`context`)
) ENGINE=InnoDB AUTO_INCREMENT=130 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `machines_mqe`;
CREATE TABLE `machines_mqe` (
  `id` int NOT NULL,
  `name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `description` varchar(5000) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `menus`;
CREATE TABLE `menus` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `parent_id` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `inner_link` int DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `message_sources`;
CREATE TABLE `message_sources` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `is_default` tinyint(1) NOT NULL DEFAULT '0',
  `APIKEY` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `settings` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `meta_data_types`;
CREATE TABLE `meta_data_types` (
  `id` int NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `create_at` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT 'CURRENT_TIMESTAMP',
  `updated_at` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT 'CURRENT_TIMESTAMP',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `migrations`;
CREATE TABLE `migrations` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `migration` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `batch` int NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `order_histories`;
CREATE TABLE `order_histories` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `order_id` int DEFAULT NULL,
  `customer_id` int DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `invoice_id` int DEFAULT NULL,
  `request` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `quantity` int DEFAULT NULL,
  `price` int DEFAULT NULL,
  `shippingCharges` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `shipperCode` int DEFAULT NULL,
  `IVA` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `IVAReturn` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `status_id` int DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `user_ip` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `user_agent` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request_url` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request_data` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `unique_machine` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `updated_user_id` int DEFAULT NULL,
  `referal_user_id` int DEFAULT NULL,
  `authorizationResult` int DEFAULT NULL,
  `authorizationCode` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `errorCode` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `errorMessage` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `added_at` timestamp NULL DEFAULT NULL,
  `notes` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `delivery_date` timestamp NULL DEFAULT NULL,
  `delivery_name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_address` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_to` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_from` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_message` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `payment_form` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `payment_id` int DEFAULT NULL,
  `session_id` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_bin DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `customer_id` (`customer_id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `order_products`;
CREATE TABLE `order_products` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `order_id` int DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `price` int DEFAULT NULL,
  `quantity` int DEFAULT NULL,
  `discount` int DEFAULT NULL,
  `total` int DEFAULT NULL,
  `description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `order_id` (`order_id`)
) ENGINE=MyISAM AUTO_INCREMENT=224 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `order_statuses`;
CREATE TABLE `order_statuses` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `color` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `status_id` int DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `order_statuses_old`;
CREATE TABLE `order_statuses_old` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `color` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `order_transactions`;
CREATE TABLE `order_transactions` (
  `id` int NOT NULL,
  `type_id` int DEFAULT NULL,
  `internal_id` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `date` date DEFAULT NULL,
  `url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `debit` double DEFAULT NULL,
  `credit` double DEFAULT NULL,
  `account_id` int DEFAULT NULL,
  `order_id` int DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `orders`;
CREATE TABLE `orders` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `customer_id` int DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `invoice_id` int DEFAULT NULL,
  `quantity` int DEFAULT NULL,
  `price` int DEFAULT NULL,
  `shippingCharges` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `shipperCode` int DEFAULT NULL,
  `IVA` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `IVAReturn` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `status_id` int DEFAULT NULL,
  `user_ip` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `user_agent` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request_url` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `request_data` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `unique_machine` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `user_id` int DEFAULT NULL,
  `updated_user_id` int DEFAULT NULL,
  `referal_user_id` int DEFAULT NULL,
  `authorizationResult` int DEFAULT NULL,
  `authorizationCode` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `errorCode` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `errorMessage` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `added_at` timestamp NULL DEFAULT NULL,
  `notes` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `delivery_date` timestamp NULL DEFAULT NULL,
  `delivery_name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_address` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_city` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_country` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_to` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_postal_code` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_from` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `delivery_message` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `payment_form` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `payment_id` int DEFAULT NULL,
  `session_id` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_bin DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `billing_name` varchar(250) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_document` varchar(100) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_phone` varchar(50) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_phone2` varchar(50) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_email` varchar(250) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_address` varchar(250) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_city` varchar(100) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_country` varchar(100) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `customer_id` (`customer_id`),
  KEY `idx_orders_customer_invoice` (`customer_id`,`invoice_id`)
) ENGINE=MyISAM AUTO_INCREMENT=233 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `orders_customers`;
CREATE TABLE `orders_customers` (
  `id` int unsigned NOT NULL,
  `order_id` int DEFAULT NULL,
  `customer_id` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `password_reset_tokens`;
CREATE TABLE `password_reset_tokens` (
  `email` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `token` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `payments`;
CREATE TABLE `payments` (
  `id` int unsigned NOT NULL,
  `name` varchar(150) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `personal_access_tokens`;
CREATE TABLE `personal_access_tokens` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `tokenable_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `tokenable_id` bigint unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `token` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `abilities` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `last_used_at` timestamp NULL DEFAULT NULL,
  `expires_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `personal_access_tokens_token_unique` (`token`),
  KEY `personal_access_tokens_tokenable_type_tokenable_id_index` (`tokenable_type`,`tokenable_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `phone_validate`;
CREATE TABLE `phone_validate` (
  `phone` bigint DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;

DROP TABLE IF EXISTS `polls`;
CREATE TABLE `polls` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `product_statuses`;
CREATE TABLE `product_statuses` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `color` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `product_types`;
CREATE TABLE `product_types` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `parent_id` int DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `image_url` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `category_id` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `products`;
CREATE TABLE `products` (
  `id` int NOT NULL,
  `name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `alias` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `active` int DEFAULT '1',
  `price` double DEFAULT NULL,
  `shipping` int DEFAULT NULL,
  `total` int DEFAULT NULL,
  `country` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `coin` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `colombia_price` int DEFAULT NULL,
  `america_price` double DEFAULT NULL,
  `america_shipping` int DEFAULT NULL,
  `ecuador_price` int DEFAULT NULL,
  `ecuador_shipping` int DEFAULT NULL,
  `ecuador_total_price` int DEFAULT NULL,
  `europa_price` int DEFAULT NULL,
  `europa_shipping` int DEFAULT NULL,
  `colombia_coin` varchar(5) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `europa_coin` varchar(5) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `america_coin` varchar(5) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `registration` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `category_id` int DEFAULT NULL,
  `description` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `description_to_print` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `status_id` int DEFAULT '1',
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00'
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `projects`;
CREATE TABLE `projects` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `weight` int DEFAULT NULL,
  `phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `color` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT '',
  `sales_man` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `quiz_results`;
CREATE TABLE `quiz_results` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `slug` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `customer_id` int DEFAULT NULL,
  `quiz_meta_id` int DEFAULT NULL,
  `name` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `stage` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `final_score` decimal(8,2) DEFAULT NULL,
  `completed_at` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `answers` json DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `quiz_results_slug_unique` (`slug`),
  KEY `quiz_results_customer_id_foreign` (`customer_id`),
  CONSTRAINT `quiz_results_customer_id_foreign` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB AUTO_INCREMENT=89 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `quotes`;
CREATE TABLE `quotes` (
  `id` int NOT NULL,
  `date` date DEFAULT NULL,
  `time` time DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `customer_id` int DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `references`;
CREATE TABLE `references` (
  `id` int unsigned NOT NULL,
  `customer_id` int DEFAULT NULL,
  `value` bigint DEFAULT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `note` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `email` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `phone` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `document_number` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT '',
  `status_id` varchar(150) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  `billing_nationality` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_city` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_address` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `billing_country` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `product_name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `shipping_city` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `shipping_address` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `shipping_country` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `trm` double DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `request_logs`;
CREATE TABLE `request_logs` (
  `id` int NOT NULL AUTO_INCREMENT,
  `request` text COLLATE utf8mb3_unicode_ci,
  `action` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `phone` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `facebook_id` bigint DEFAULT NULL,
  `rd_lead_id` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `ignored` tinyint(1) NOT NULL DEFAULT '0',
  `ignore_reason` varchar(255) COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `email` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `request_logs_rd_lead_id_index` (`rd_lead_id`),
  KEY `request_logs_ignored_index` (`ignored`)
) ENGINE=InnoDB AUTO_INCREMENT=132220 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `requests`;
CREATE TABLE `requests` (
  `id` int unsigned NOT NULL,
  `customer_id` int DEFAULT NULL,
  `type_id` int DEFAULT NULL,
  `note` text CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `retell_inbox`;
CREATE TABLE `retell_inbox` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `call_id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `status` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `payload` json NOT NULL,
  `processed_at` timestamp NULL DEFAULT NULL,
  `error` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `retell_inbox_call_id_unique` (`call_id`),
  KEY `retell_inbox_call_id_index` (`call_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `role_menus`;
CREATE TABLE `role_menus` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `role_id` int DEFAULT NULL,
  `menu_id` int DEFAULT NULL,
  `create` tinyint(1) DEFAULT '1',
  `read` tinyint(1) DEFAULT '1',
  `update` tinyint(1) DEFAULT '1',
  `delete` tinyint(1) DEFAULT '1',
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `role_menus_id_idx` (`id`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `role_products`;
CREATE TABLE `role_products` (
  `id` int NOT NULL,
  `role_id` int DEFAULT NULL,
  `product_id` int DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `roles`;
CREATE TABLE `roles` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=16 DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `sales`;
CREATE TABLE `sales` (
  `id` int unsigned NOT NULL,
  `date` date DEFAULT NULL,
  `customer_id` int DEFAULT NULL,
  `user_id` int DEFAULT NULL,
  `value` double DEFAULT NULL,
  `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `service_files`;
CREATE TABLE `service_files` (
  `id` int unsigned NOT NULL,
  `service_id` int NOT NULL,
  `url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `service_statuses`;
CREATE TABLE `service_statuses` (
  `id` int unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `service_types`;
CREATE TABLE `service_types` (
  `id` int unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `logo_url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `services`;
CREATE TABLE `services` (
  `id` int unsigned NOT NULL,
  `account_id` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `service_type_id` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `service_status_id` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `project_budget` bigint DEFAULT NULL,
  `fee_budget` bigint DEFAULT NULL,
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `sessions`;
CREATE TABLE `sessions` (
  `id` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `user_id` bigint unsigned DEFAULT NULL,
  `ip_address` varchar(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `user_agent` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `payload` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `last_activity` int NOT NULL,
  PRIMARY KEY (`id`),
  KEY `sessions_user_id_index` (`user_id`),
  KEY `sessions_last_activity_index` (`last_activity`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `stages`;
CREATE TABLE `stages` (
  `id` int unsigned NOT NULL,
  `name` varchar(250) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `type_id` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `tags`;
CREATE TABLE `tags` (
  `id` int unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `slug` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `color` varchar(20) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `description` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `tags_name_unique` (`name`),
  UNIQUE KEY `tags_slug_unique` (`slug`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `temp`;
CREATE TABLE `temp` (
  `email` varchar(45) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `tmp_ordered`;
CREATE TABLE `tmp_ordered` (
  `id` int NOT NULL DEFAULT '0',
  `rn` bigint unsigned NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `tmp_to_assign`;
CREATE TABLE `tmp_to_assign` (
  `id` int NOT NULL DEFAULT '0'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `user_message_sources`;
CREATE TABLE `user_message_sources` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint unsigned NOT NULL,
  `message_source_id` bigint unsigned NOT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `is_default` tinyint(1) NOT NULL DEFAULT '0',
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `user_message_sources_user_id_foreign` (`user_id`),
  KEY `user_message_sources_message_source_id_foreign` (`message_source_id`),
  CONSTRAINT `user_message_sources_message_source_id_foreign` FOREIGN KEY (`message_source_id`) REFERENCES `message_sources` (`id`) ON DELETE CASCADE,
  CONSTRAINT `user_message_sources_user_id_foreign` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `user_statuses`;
CREATE TABLE `user_statuses` (
  `id` int NOT NULL,
  `name` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `include_reports` int DEFAULT NULL,
  `last_assigned` int DEFAULT NULL,
  `status_id` int DEFAULT NULL,
  `email` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `notify_email` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `role_id` int DEFAULT NULL,
  `assignable` int DEFAULT NULL,
  `image_url` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `last_login` timestamp NULL DEFAULT NULL,
  `email_verified_at` timestamp NULL DEFAULT NULL,
  `channels_id` int DEFAULT NULL,
  `password` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `remember_token` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `users_email_unique` (`email`)
) ENGINE=InnoDB AUTO_INCREMENT=132 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `users_roles`;
CREATE TABLE `users_roles` (
  `id` int NOT NULL,
  `user_id` int NOT NULL,
  `role_id` int NOT NULL,
  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;

DROP VIEW IF EXISTS `v_es_customers`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_event_madrid2025_kpis`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_event_madrid2025_participation`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_event_status`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_madrid2025_es`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_madrid2025_es_consolidated`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_madrid2025_event_status`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_madrid2025_unified`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_pauta_customers`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP VIEW IF EXISTS `v_phone_usa`;


CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;DROP TABLE IF EXISTS `validates_phones`;
CREATE TABLE `validates_phones` (
  `phone` bigint DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;

DROP TABLE IF EXISTS `whatsapp_accounts`;
CREATE TABLE `whatsapp_accounts` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `phone_number` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `phone_number_id` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `business_account_id` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `api_url` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `api_token` text COLLATE utf8mb4_unicode_ci NOT NULL,
  `is_default` tinyint(1) NOT NULL DEFAULT '0',
  `settings` json DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `whatsapp_messages_map`;
CREATE TABLE `whatsapp_messages_map` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `external_message_id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `wire_message_id` bigint unsigned NOT NULL,
  `wa_id` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `raw_payload` json NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `whatsapp_messages_map_external_message_id_unique` (`external_message_id`),
  KEY `whatsapp_messages_map_wire_message_id_foreign` (`wire_message_id`),
  KEY `whatsapp_messages_map_wa_id_index` (`wa_id`),
  CONSTRAINT `whatsapp_messages_map_wire_message_id_foreign` FOREIGN KEY (`wire_message_id`) REFERENCES `wire_messages` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=489 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `whatsapp_templates`;
CREATE TABLE `whatsapp_templates` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `whatsapp_account_id` bigint unsigned NOT NULL,
  `name` varchar(255) COLLATE utf8mb4_unicode_ci NOT NULL,
  `language` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `category` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `status` varchar(255) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `whatsapp_templates_whatsapp_account_id_foreign` (`whatsapp_account_id`),
  CONSTRAINT `whatsapp_templates_whatsapp_account_id_foreign` FOREIGN KEY (`whatsapp_account_id`) REFERENCES `whatsapp_accounts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=76 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_actions`;
CREATE TABLE `wire_actions` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `actionable_id` bigint unsigned NOT NULL,
  `actionable_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `actor_id` bigint unsigned NOT NULL,
  `actor_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `data` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL COMMENT 'Some additional information about the action',
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `wire_actions_actionable_id_actionable_type_index` (`actionable_id`,`actionable_type`),
  KEY `wire_actions_actor_id_actor_type_index` (`actor_id`,`actor_type`),
  KEY `wire_actions_type_index` (`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_attachments`;
CREATE TABLE `wire_attachments` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `attachable_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `attachable_id` bigint unsigned NOT NULL,
  `file_path` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `file_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `original_name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `mime_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `wire_attachments_attachable_type_attachable_id_index` (`attachable_type`,`attachable_id`),
  KEY `wire_attachments_attachable_id_attachable_type_index` (`attachable_id`,`attachable_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_conversations`;
CREATE TABLE `wire_conversations` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Private is 1-1 , group or channel',
  `disappearing_started_at` timestamp NULL DEFAULT NULL,
  `disappearing_duration` int DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `wire_conversations_type_index` (`type`)
) ENGINE=InnoDB AUTO_INCREMENT=83 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_groups`;
CREATE TABLE `wire_groups` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `conversation_id` bigint unsigned NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `description` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `avatar_url` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci DEFAULT NULL,
  `type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'private',
  `allow_members_to_send_messages` tinyint(1) NOT NULL DEFAULT '1',
  `allow_members_to_add_others` tinyint(1) NOT NULL DEFAULT '1',
  `allow_members_to_edit_group_info` tinyint(1) NOT NULL DEFAULT '0',
  `admins_must_approve_new_members` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'when turned on, admins must approve anyone who wants to join group',
  `deleted_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `wire_groups_conversation_id_foreign` (`conversation_id`),
  CONSTRAINT `wire_groups_conversation_id_foreign` FOREIGN KEY (`conversation_id`) REFERENCES `wire_conversations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_messages`;
CREATE TABLE `wire_messages` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `conversation_id` bigint unsigned DEFAULT NULL,
  `sendable_id` bigint unsigned NOT NULL,
  `sendable_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `reply_id` bigint unsigned DEFAULT NULL,
  `body` text CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci,
  `type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'text',
  `kept_at` timestamp NULL DEFAULT NULL COMMENT 'filled when a message is kept from disappearing',
  `deleted_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `wire_messages_reply_id_foreign` (`reply_id`),
  KEY `wire_messages_conversation_id_index` (`conversation_id`),
  KEY `wire_messages_sendable_id_sendable_type_index` (`sendable_id`,`sendable_type`),
  CONSTRAINT `wire_messages_conversation_id_foreign` FOREIGN KEY (`conversation_id`) REFERENCES `wire_conversations` (`id`) ON DELETE CASCADE,
  CONSTRAINT `wire_messages_reply_id_foreign` FOREIGN KEY (`reply_id`) REFERENCES `wire_messages` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB AUTO_INCREMENT=478 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wire_participants`;
CREATE TABLE `wire_participants` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `conversation_id` bigint unsigned NOT NULL,
  `role` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `participantable_id` bigint unsigned NOT NULL,
  `participantable_type` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
  `exited_at` timestamp NULL DEFAULT NULL,
  `last_active_at` timestamp NULL DEFAULT NULL,
  `conversation_cleared_at` timestamp NULL DEFAULT NULL,
  `conversation_deleted_at` timestamp NULL DEFAULT NULL,
  `conversation_read_at` timestamp NULL DEFAULT NULL,
  `deleted_at` timestamp NULL DEFAULT NULL,
  `created_at` timestamp NULL DEFAULT NULL,
  `updated_at` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `conv_part_id_type_unique` (`conversation_id`,`participantable_id`,`participantable_type`),
  KEY `wire_participants_role_index` (`role`),
  KEY `wire_participants_exited_at_index` (`exited_at`),
  KEY `wire_participants_conversation_cleared_at_index` (`conversation_cleared_at`),
  KEY `wire_participants_conversation_deleted_at_index` (`conversation_deleted_at`),
  KEY `wire_participants_conversation_read_at_index` (`conversation_read_at`),
  CONSTRAINT `wire_participants_conversation_id_foreign` FOREIGN KEY (`conversation_id`) REFERENCES `wire_conversations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=165 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

DROP TABLE IF EXISTS `wp_todos_usa`;
CREATE TABLE `wp_todos_usa` (
  `name` varchar(39) DEFAULT NULL,
  `phone` varchar(13) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;



CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025` AS select `RFM2025_BASE`.`customer_id` AS `customer_id`,`RFM2025_BASE`.`name` AS `name`,`RFM2025_BASE`.`phone` AS `phone`,`RFM2025_BASE`.`recency` AS `recency`,`RFM2025_BASE`.`frequency` AS `frequency`,`RFM2025_BASE`.`money` AS `money`,`RFM2025_BASE`.`last_action_date` AS `last_action_date`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc )  AS `recency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` )  AS `frequency_points`,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` )  AS `money_points`,concat(ntile(5) OVER (ORDER BY `RFM2025_BASE`.`recency` desc ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`frequency` ) ,ntile(5) OVER (ORDER BY `RFM2025_BASE`.`money` ) ) AS `rfm_score` from `RFM2025_BASE`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM2025_BASE` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone` AS `phone`,(to_days(curdate()) - to_days(max(`a`.`created_at`))) AS `recency`,count(`a`.`id`) AS `frequency`,unix_timestamp(`c`.`created_at`) AS `money`,max(`a`.`created_at`) AS `last_action_date` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`status_id` not in (8,9,62,42,18,53,27)) and (year(`c`.`created_at`) = 2025)) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone`,`c`.`email` AS `email`,`c`.`maker` AS `maker`,coalesce(count(`a`.`id`),0) AS `total_actions`,(case when (count(`a`.`id`) = 0) then 'F0' when (count(`a`.`id`) = 1) then 'F1' when (count(`a`.`id`) = 2) then 'F2' when (count(`a`.`id`) between 3 and 5) then 'F3' when (count(`a`.`id`) between 6 and 10) then 'F4' when (count(`a`.`id`) between 11 and 20) then 'F5' else 'F6' end) AS `F_score`,max(`a`.`created_at`) AS `last_action_date`,(case when (max(`a`.`created_at`) is null) then NULL else (to_days(now()) - to_days(max(`a`.`created_at`))) end) AS `days_since_last_action`,(case when (max(`a`.`created_at`) is null) then 'R0' when ((to_days(now()) - to_days(max(`a`.`created_at`))) <= 90) then 'R1' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 91 and 180) then 'R2' when ((to_days(now()) - to_days(max(`a`.`created_at`))) between 181 and 365) then 'R3' else 'R4' end) AS `R_score`,(case when (`c`.`maker` is null) then 'M0' when (`c`.`maker` = 1) then 'M1' when (`c`.`maker` = 0) then 'M2' else 'M0' end) AS `M_score`,(case when (max(`a`.`created_at`) is null) then 1 when ((to_days(now()) - to_days(max(`a`.`created_at`))) > 90) then 1 else 0 end) AS `should_recycle` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((year(`c`.`created_at`) = 2025) and (`c`.`phone_wp` is not null)) group by `c`.`id` order by `days_since_last_action` desc,`total_actions`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_TEST` AS with `R5_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R5_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 5) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R4_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 4) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R3_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 3) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 5) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 4) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` = 3) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50), `R2_F21` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((`customers`.`rfm_r` = 2) and (`customers`.`rfm_f` in (1,2)) and (year(`customers`.`created_at`) = 2025) and (`customers`.`phone_wp` is not null) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (not((`customers`.`notes` like '%#CRECE2025%')))) limit 50) select `R5_F5`.`id` AS `id`,`R5_F5`.`name` AS `name`,`R5_F5`.`phone_wp` AS `phone_wp`,`R5_F5`.`rfm_r` AS `rfm_r`,`R5_F5`.`rfm_f` AS `rfm_f` from `R5_F5` union all select `R5_F4`.`id` AS `id`,`R5_F4`.`name` AS `name`,`R5_F4`.`phone_wp` AS `phone_wp`,`R5_F4`.`rfm_r` AS `rfm_r`,`R5_F4`.`rfm_f` AS `rfm_f` from `R5_F4` union all select `R5_F3`.`id` AS `id`,`R5_F3`.`name` AS `name`,`R5_F3`.`phone_wp` AS `phone_wp`,`R5_F3`.`rfm_r` AS `rfm_r`,`R5_F3`.`rfm_f` AS `rfm_f` from `R5_F3` union all select `R5_F21`.`id` AS `id`,`R5_F21`.`name` AS `name`,`R5_F21`.`phone_wp` AS `phone_wp`,`R5_F21`.`rfm_r` AS `rfm_r`,`R5_F21`.`rfm_f` AS `rfm_f` from `R5_F21` union all select `R4_F5`.`id` AS `id`,`R4_F5`.`name` AS `name`,`R4_F5`.`phone_wp` AS `phone_wp`,`R4_F5`.`rfm_r` AS `rfm_r`,`R4_F5`.`rfm_f` AS `rfm_f` from `R4_F5` union all select `R4_F4`.`id` AS `id`,`R4_F4`.`name` AS `name`,`R4_F4`.`phone_wp` AS `phone_wp`,`R4_F4`.`rfm_r` AS `rfm_r`,`R4_F4`.`rfm_f` AS `rfm_f` from `R4_F4` union all select `R4_F3`.`id` AS `id`,`R4_F3`.`name` AS `name`,`R4_F3`.`phone_wp` AS `phone_wp`,`R4_F3`.`rfm_r` AS `rfm_r`,`R4_F3`.`rfm_f` AS `rfm_f` from `R4_F3` union all select `R4_F21`.`id` AS `id`,`R4_F21`.`name` AS `name`,`R4_F21`.`phone_wp` AS `phone_wp`,`R4_F21`.`rfm_r` AS `rfm_r`,`R4_F21`.`rfm_f` AS `rfm_f` from `R4_F21` union all select `R3_F5`.`id` AS `id`,`R3_F5`.`name` AS `name`,`R3_F5`.`phone_wp` AS `phone_wp`,`R3_F5`.`rfm_r` AS `rfm_r`,`R3_F5`.`rfm_f` AS `rfm_f` from `R3_F5` union all select `R3_F4`.`id` AS `id`,`R3_F4`.`name` AS `name`,`R3_F4`.`phone_wp` AS `phone_wp`,`R3_F4`.`rfm_r` AS `rfm_r`,`R3_F4`.`rfm_f` AS `rfm_f` from `R3_F4` union all select `R3_F3`.`id` AS `id`,`R3_F3`.`name` AS `name`,`R3_F3`.`phone_wp` AS `phone_wp`,`R3_F3`.`rfm_r` AS `rfm_r`,`R3_F3`.`rfm_f` AS `rfm_f` from `R3_F3` union all select `R3_F21`.`id` AS `id`,`R3_F21`.`name` AS `name`,`R3_F21`.`phone_wp` AS `phone_wp`,`R3_F21`.`rfm_r` AS `rfm_r`,`R3_F21`.`rfm_f` AS `rfm_f` from `R3_F21` union all select `R2_F5`.`id` AS `id`,`R2_F5`.`name` AS `name`,`R2_F5`.`phone_wp` AS `phone_wp`,`R2_F5`.`rfm_r` AS `rfm_r`,`R2_F5`.`rfm_f` AS `rfm_f` from `R2_F5` union all select `R2_F4`.`id` AS `id`,`R2_F4`.`name` AS `name`,`R2_F4`.`phone_wp` AS `phone_wp`,`R2_F4`.`rfm_r` AS `rfm_r`,`R2_F4`.`rfm_f` AS `rfm_f` from `R2_F4` union all select `R2_F3`.`id` AS `id`,`R2_F3`.`name` AS `name`,`R2_F3`.`phone_wp` AS `phone_wp`,`R2_F3`.`rfm_r` AS `rfm_r`,`R2_F3`.`rfm_f` AS `rfm_f` from `R2_F3` union all select `R2_F21`.`id` AS `id`,`R2_F21`.`name` AS `name`,`R2_F21`.`phone_wp` AS `phone_wp`,`R2_F21`.`rfm_r` AS `rfm_r`,`R2_F21`.`rfm_f` AS `rfm_f` from `R2_F21`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_WINNERS_` AS select `c`.`id` AS `id`,`c`.`name` AS `name`,`c`.`phone_wp` AS `phone_wp`,`c`.`rfm_r` AS `rfm_r`,`c`.`rfm_f` AS `rfm_f` from `customers` `c` where ((year(`c`.`created_at`) = 2025) and (`c`.`status_id` not in (8,9,62,42,18,53,27)) and (`c`.`phone_wp` is not null) and (((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 5) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 2)) or ((`c`.`rfm_r` = 3) and (`c`.`rfm_f` = 5)) or ((`c`.`rfm_r` = 2) and (`c`.`rfm_f` = 4)) or ((`c`.`rfm_r` = 4) and (`c`.`rfm_f` = 5))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `RFM_2025_test` AS with `R5` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 5) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R4` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 4) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R3` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 3) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200), `R2` as (select `customers`.`id` AS `id`,`customers`.`name` AS `name`,`customers`.`phone_wp` AS `phone_wp`,`customers`.`rfm_r` AS `rfm_r`,`customers`.`rfm_f` AS `rfm_f` from `customers` where ((year(`customers`.`created_at`) = 2025) and (`customers`.`status_id` not in (8,9,62,42,18,53,27)) and (`customers`.`rfm_r` = 2) and (`customers`.`phone_wp` is not null) and (not((`customers`.`notes` like '%#CRECE2025_ENVIADO%'))) and (not((`customers`.`notes` like '%#CRECE2025_RESPONDE%')))) order by `customers`.`rfm_f` desc,`customers`.`created_at` desc limit 200) select `R5`.`id` AS `id`,`R5`.`name` AS `name`,`R5`.`phone_wp` AS `phone_wp`,`R5`.`rfm_r` AS `rfm_r`,`R5`.`rfm_f` AS `rfm_f` from `R5` union all select `R4`.`id` AS `id`,`R4`.`name` AS `name`,`R4`.`phone_wp` AS `phone_wp`,`R4`.`rfm_r` AS `rfm_r`,`R4`.`rfm_f` AS `rfm_f` from `R4` union all select `R3`.`id` AS `id`,`R3`.`name` AS `name`,`R3`.`phone_wp` AS `phone_wp`,`R3`.`rfm_r` AS `rfm_r`,`R3`.`rfm_f` AS `rfm_f` from `R3` union all select `R2`.`id` AS `id`,`R2`.`name` AS `name`,`R2`.`phone_wp` AS `phone_wp`,`R2`.`rfm_r` AS `rfm_r`,`R2`.`rfm_f` AS `rfm_f` from `R2`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_es_customers` AS select `c`.`id` AS `customer_id` from `customers` `c` where (regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain')));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_kpis` AS select count(0) AS `total_tagged`,sum(((`v_event_madrid2025_participation`.`wa_out` > 0) or (`v_event_madrid2025_participation`.`emails_out` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0) or (`v_event_madrid2025_participation`.`social_in` > 0) or (`v_event_madrid2025_participation`.`ai_interactions` > 0))) AS `reached`,sum(((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`email_open` > 0))) AS `engaged`,sum((((`v_event_madrid2025_participation`.`wa_in` > 0) or (`v_event_madrid2025_participation`.`emails_in` > 0) or (`v_event_madrid2025_participation`.`calls_out` > 0)) and ((`v_event_madrid2025_participation`.`score_flag` = 1) or (`v_event_madrid2025_participation`.`score_interest` >= 3)))) AS `qualified`,sum((`v_event_madrid2025_participation`.`rsvp_confirmed` = 1)) AS `rsvps`,sum((`v_event_madrid2025_participation`.`attended` = 1)) AS `attended`,sum((`v_event_madrid2025_participation`.`no_show` = 1)) AS `no_show`,sum(`v_event_madrid2025_participation`.`wa_out`) AS `wa_out_msgs`,sum(`v_event_madrid2025_participation`.`wa_in`) AS `wa_in_msgs`,sum(`v_event_madrid2025_participation`.`emails_out`) AS `emails_out_msgs`,sum(`v_event_madrid2025_participation`.`email_open`) AS `email_opens`,sum(`v_event_madrid2025_participation`.`calls_out`) AS `calls_made`,sum(`v_event_madrid2025_participation`.`ai_interactions`) AS `ai_sessions` from `v_event_madrid2025_participation`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_madrid2025_participation` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `account_name`,`c`.`country` AS `country`,`c`.`city` AS `city`,`c`.`email` AS `email`,`c`.`phone` AS `phone`,`c`.`phone_wp` AS `phone_wp`,`c`.`user_id` AS `owner_id`,((0 <> (case when (`c`.`notes` like '%#Madrid2025%') then 1 else 0 end)) or exists(select 1 from `actions` `a2` where ((`a2`.`customer_id` = `c`.`id`) and (`a2`.`note` like '%#Madrid2025%')))) AS `tagged_madrid2025`,sum((`a`.`type_id` = 14)) AS `wa_out`,sum((`a`.`type_id` = 8)) AS `wa_in`,sum((`a`.`type_id` in (1,21,20))) AS `calls_out`,sum((`a`.`type_id` = 2)) AS `emails_out`,sum((`a`.`type_id` = 23)) AS `emails_in`,sum((`a`.`type_id` = 4)) AS `email_open`,sum((`a`.`type_id` in (6,7))) AS `social_in`,sum(((`a`.`note` like '%chatbot%') or (`a`.`note` like '%IA%'))) AS `ai_interactions`,max((`a`.`type_id` = 101)) AS `rsvp_confirmed`,max((`a`.`type_id` = 102)) AS `attended`,max((`a`.`type_id` = 103)) AS `no_show`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `attended_at`,`c`.`scoring` AS `score_flag`,`c`.`scoring_interest` AS `score_interest`,`c`.`utm_source` AS `utm_source`,`c`.`utm_medium` AS `utm_medium`,`c`.`utm_campaign` AS `utm_campaign`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Madrid2025%') or (`a`.`note` like '%#Madrid2025%')) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_event_status` AS select `c`.`id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es` AS select `c`.`id` AS `customer_id`,`c`.`name` AS `name`,`c`.`business` AS `business`,`c`.`country` AS `country`,`c`.`phone` AS `phone`,`c`.`phone2` AS `phone2`,`c`.`phone_wp` AS `phone_wp`,`c`.`area_code` AS `area_code`,`c`.`email` AS `email`,`c`.`notes` AS `notes`,`c`.`created_at` AS `created_at`,(case when regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') then 1 else 0 end) AS `tag_in_customer` from `customers` `c` where ((regexp_like(`c`.`phone`,'^\\+?34') or regexp_like(`c`.`phone2`,'^\\+?34') or regexp_like(`c`.`phone_wp`,'^\\+?34') or (`c`.`area_code` = '34') or (`c`.`country` in ('Espaa','Spain'))) and (regexp_like(`c`.`notes`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)') or exists(select 1 from `actions` `a` where ((`a`.`customer_id` = `c`.`id`) and regexp_like(`a`.`note`,'#(Espaa|Espaa2025|Tour_Madrid_Pauta)')))));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_es_consolidated` AS select `v`.`customer_id` AS `customer_id`,`v`.`name` AS `name`,`v`.`business` AS `business`,`v`.`country` AS `country`,coalesce(`v`.`phone_wp`,`v`.`phone`,`v`.`phone2`) AS `phone_main`,`v`.`email` AS `email`,`v`.`tag_in_customer` AS `tag_in_customer`,`es`.`last_rsvp_at` AS `last_rsvp_at`,`es`.`last_attended_at` AS `last_attended_at`,`es`.`last_noshow_at` AS `last_noshow_at`,`es`.`rsvp_cnt` AS `rsvp_cnt`,`es`.`attended_cnt` AS `attended_cnt`,`es`.`noshow_cnt` AS `noshow_cnt`,(select `at`.`name` from (`actions` `a2` join `action_types` `at` on((`at`.`id` = `a2`.`type_id`))) where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_name`,(select `a2`.`created_at` from `actions` `a2` where (`a2`.`customer_id` = `v`.`customer_id`) order by `a2`.`created_at` desc limit 1) AS `last_action_at` from (`v_madrid2025_es` `v` left join `v_madrid2025_event_status` `es` on((`es`.`customer_id` = `v`.`customer_id`)));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_event_status` AS select `c`.`customer_id` AS `customer_id`,max((case when (`a`.`type_id` = 101) then `a`.`created_at` end)) AS `last_rsvp_at`,max((case when (`a`.`type_id` = 102) then `a`.`created_at` end)) AS `last_attended_at`,max((case when (`a`.`type_id` = 103) then `a`.`created_at` end)) AS `last_noshow_at`,sum((case when (`a`.`type_id` = 101) then 1 else 0 end)) AS `rsvp_cnt`,sum((case when (`a`.`type_id` = 102) then 1 else 0 end)) AS `attended_cnt`,sum((case when (`a`.`type_id` = 103) then 1 else 0 end)) AS `noshow_cnt` from (`v_madrid2025_es` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`customer_id`))) group by `c`.`customer_id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_madrid2025_unified` AS select `c`.`id` AS `customer_id`,coalesce(convert(`c`.`business` using utf8mb4),`c`.`name`) AS `name`,`c`.`country` AS `country`,`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`) AS `phone`,`c`.`email` AS `email`,1 AS `is_es`,(`c`.`notes` like '%#EspaaPauta%') AS `is_pauta`,max(`a`.`created_at`) AS `last_action_at` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where (((`c`.`phone` like '+34%') and (length(`c`.`phone`) = 12)) or ((`c`.`phone` like '34%') and (length(`c`.`phone`) = 11)) or ((`c`.`phone2` like '+34%') and (length(`c`.`phone2`) = 12)) or ((`c`.`phone2` like '34%') and (length(`c`.`phone2`) = 11)) or ((`c`.`contact_phone2` like '+34%') and (length(`c`.`contact_phone2`) = 12)) or ((`c`.`contact_phone2` like '34%') and (length(`c`.`contact_phone2`) = 11)) or ((length(`getPhone3`(`c`.`phone`,`c`.`phone2`,`c`.`contact_phone2`)) = 11) and (`c`.`country` in ('Espaa','ES','Spain')))) group by `c`.`id`;
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_pauta_customers` AS select distinct `c`.`id` AS `customer_id` from (`customers` `c` left join `actions` `a` on((`a`.`customer_id` = `c`.`id`))) where ((`c`.`notes` like '%#Tour_Madrid_Pauta%') or (`a`.`note` like '%#Tour_Madrid_Pauta%'));
CREATE ALGORITHM=UNDEFINED DEFINER=`forge`@`%` SQL SECURITY DEFINER VIEW `v_phone_usa` AS select `customers`.`name` AS `name`,`customers`.`country` AS `country`,`getPhone3`(`customers`.`phone`,`customers`.`phone2`,`customers`.`contact_phone2`) AS `phone`,`customers`.`email` AS `email` from `customers` where (regexp_like(`customers`.`phone`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or regexp_like(`customers`.`contact_phone2`,'^(\\+1|1)[2-9][0-9]{9}$') or (`customers`.`country` like '%USA%') or (`customers`.`country` like '%United States%') or (`customers`.`country` like '%Estados Unidos%') or (`customers`.`country` like '%EEUU%'));
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;
ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION;


/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;